name: Dcat Admin Laravel v5

on:
  push:
    branches: [ 2.0 ]
  pull_request:
    branches: [ 2.0 ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: shivammathur/setup-php@b7d1d9c9a92d8d8463ce36d7f60da34d461724f8
        with:
          php-version: '7.1'

      - uses: nanasess/setup-chromedriver@master
        with:
          # Optional: do not specify to match Chrome's version
          chromedriver-version: '89.0.4389.23'

      - run: |
          export DISPLAY=:99
          chromedriver --url-base=/wd/hub &

      - uses: actions/checkout@v2

      - name: Validate composer.json and composer.lock
        run: |
          composer self-update --2
          composer validate --strict

      - name: Install dependencies
        run: |
          composer create-project --prefer-dist laravel/laravel laravel-tests 5.*
          cp -f ./tests/resources/stubs/artisan ./laravel-tests/
          cp -f ./tests/resources/stubs/ComposerConfigCommand.php ./laravel-tests/app/
          mkdir ./laravel-tests/dcat-admin
          cp -rf ./config ./laravel-tests/dcat-admin
          cp -rf ./database ./laravel-tests/dcat-admin
          cp -rf ./resources ./laravel-tests/dcat-admin
          cp -rf ./src ./laravel-tests/dcat-admin
          cp -rf ./tests ./laravel-tests/dcat-admin
          cp -rf ./composer.json ./laravel-tests/dcat-admin
          rm -rf ./laravel-tests/tests
          cp -rf ./tests ./laravel-tests/tests
          cp -f ./phpunit.dusk.xml ./laravel-tests
          cp -f ./.env.testing ./laravel-tests/.env
          cd ./laravel-tests
          php artisan admin:composer-config
          composer require dcat/laravel-admin:*@dev
          composer require laravel/dusk --dev # --ignore-platform-reqs

      - name: Create Database
        run: |
          mkdir -p database
          touch database/database.sqlite
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

      - name: Install Adminn
        run: |
          cd ./laravel-tests
          php artisan admin:publish --force
          php artisan admin:install
          php artisan migrate:rollback
          php artisan dusk:chrome-driver 89
          cp -f ./tests/routes.php ./app/Admin/
          cp -rf ./tests/resources/config ./config/

      - name: Start Server
        run: export DISPLAY=:99.0
          sudo sh -e /etc/init.d/xvfb start
          ./vendor/laravel/dusk/bin/chromedriver-linux --headless --disable-gpu --remote-debugging-port=9515 http://localhost &
          php artisan serve &

      - name: Run test suite
        run: |
          cd ./laravel-tests
          php artisan dusk
